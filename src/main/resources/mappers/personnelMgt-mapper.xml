<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="personnelMgtMapper">

	<resultMap type="PersonnelMgt" id="attendance">
		<id column="attend_no" property="attendNo" />
		<result column="mem_no" property="memNo" />
		<result column="today" property="today" />
		<result column="check_in" property="checkIn" />
		<result column="check_out" property="checkOut" />
		<result column="total_time" property="totalTime" />
		<result column="atCount" property="atCount" />
		<result column="atSum" property="atSum" />
		<result column="atAvg" property="atAvg" />
	</resultMap>
	
	<resultMap id="salaryDto" type="salaryDto">
		<id column="salary_list_no" property="salaryListNo"/>
		<result column="mem_no" property="memNo"/>
		<result column="working_year" property="workingYear"/>
		<result column="working_month" property="workingMonth"/>
		<result column="working_hour" property="workingHour"/>
		<result column="overtime_hour" property="overtimeHour"/>
		<result column="salary" property="salary"/>
		<result column="salary_day" property="salaryDay"/>
		<result column="posi_no" property="posiNo"/>
		<result column="posi_name" property="posiName"/>
		<result column="base_salary" property="baseSalary"/>
		<result column="hourly_pay" property="hourlyPay"/>
		<result column="attend_no" property="attendNo" />
		<result column="atCount" property="atCount" />
		<result column="atSum" property="atSum" />
		<result column="atAvg" property="atAvg" />
	</resultMap>
	
	<!-- 작성자 : 안소은 - null값인 퇴근시간, 총근무시간 조회 -->
	<select id="selectAttend" resultMap="attendance">
		select 
			   check_out
			 , total_time
		  from attendance
		 where mem_no = #{memNo}
		   and check_out is null
		   and total_time is null
	</select>
	
	<!-- 작성자 : 안소은 - 근무일수 조회 -->
	<select id="selectTotalWorkDay" resultMap="attendance">
		select
		       count(*) atCount
		     , ceil(sum(total_time) / 60) atSum
		     , ceil(avg(total_time) / 60) atAvg
		  from attendance
		 where mem_no = #{memNo}
		   and extract(year from today) = extract(year from sysdate)
	</select>
	
	<select id="selectToday" resultMap="attendance">
		select
		       count(*) atCount
		  from attendance
		 where to_char(today, 'YYYY-MM-DD') = to_char(sysdate, 'YYYY-MM-DD')
		   and mem_no = #{memNo}
	</select>
	
	<!-- 작성자 : 안소은 - 출근시간 insert -->
	<insert id="insertCheckIn" parameterType="personnelmgt">
		insert
		  into attendance
		  (
		    attend_no
		  , mem_no
		  , today
		  , check_in
		  )
		  values
		  (
		    seq_adno.nextval
		  , #{memNo}
		  , sysdate
		  , to_char(current_timestamp, 'hh24:mi')
		  )
	</insert>
	
	<!-- 작성자 : 안소은 - 퇴근시간 update -->
	<update id="insertCheckOut" parameterType="personnelmgt">
		update
		       attendance
		   set check_out = to_char(current_timestamp, 'hh24:mi')
		 where mem_no = #{memNo}
		   and check_out is null
		   and check_in is not null
	</update>
	
	<!-- 작성자 : 김혜미 - 급여내역 조회 -->
	<select id="slaryList" resultMap="salaryDto">
		select
		       salary_list_no
		     , s.mem_no
		     , working_year
		     , working_month
		     , working_hour
		     , overtime_hour
		     , salary
		     , salary_day
		     , p.posi_no
		     , base_salary
		     , hourly_pay
		 from salary_list s
		 join member m on (m.mem_no = s.mem_no)
		 join position p on (p.posi_no = m.posi_no)
		order
		   by working_year desc
		    , working_month desc
	</select>
	

</mapper>
